#!/usr/bin/python3

import random_crack_api as rc
import re
import ast
import json
import sys
import time
import requests

# Modulus
N = 1000000000

elapsed = int(sys.argv[2])

bodies = []

start = int(time.time())

# Parse responses
with open('response.txt','r') as f:
  stream = False
  body = False
  body_info = {}
  stream_id = -1
  stream_pattern = r"#- *Stream ID: (\d+) *-#"
  for line in f:
    m = re.search(stream_pattern,line.strip())
    if m:
      stream = True
      stream_id = int(m.group(1))
    else:
      if stream:
        if line.strip() == "-Body-":
          body = True
        else:
          if body:
            body_info = json.loads(ast.literal_eval(line.strip()))
            bodies.append((body_info["total_guesses"],body_info["response_msg"]))
            stream = False
          body = False

# Sort by sequence number
bodies.sort()

input_data = []

for i in range(int(sys.argv[1])):
  input_data.append(int(bodies[i][1].split()[-1]))

M = rc.RandomModel()

M.input_samples(input_data, rc.InputType.SCALED, N)

domain = sys.argv[3]

other_guesses = requests.get(f"https://{domain}/api/guess?num=1").json()['total_guesses'] - bodies[-1][0]

end = int(time.time())

elapsed += (end - start)
skips = (elapsed + 3) * 25 + other_guesses

for i in range(skips):
  _ = M.get_next(rc.InputType.SCALED, N)

print(M.get_next(rc.InputType.SCALED, N), skips, elapsed)